## NodeJS Unimed - Busybox - rodando no ambiente de desenvolvimento
# Este projeto é voltado para testes unistário em estágios do CI;

image: docker:latest
services:
    - docker:dind
stages:
    - Dev
    - Dev-test
    - Prod-Tag
    - Helm-Tag
    - Prod-publish
    - Deployment
    - change-image-tag

variables:
    REGISTRY: harbor.unimednatal.com.br
    REPOSITORY: busybox-nodejs/unimed/nodejs-busybox 

before_script:
    # verificando a VERSÃO do arquivo
    - make versiona_docker
    - if [ ! -f VERSION ]; then echo "A versão dessa imagem não foi encotrada!"; exit 1; else export VERSION=$(cat VERSION); fi
    - 'echo "Executando Pipeline para a imagem: $REGISTRY/$REPOSITORY:${VERSION}"'

build:
    stage: Dev
    script:
        - docker build -t $REGISTRY/$REPOSITORY .
    tags:
        - node-busy
    only:
        - docker/nodejsbusybox

dev-test:
    stage: Dev-test
    dependencies: 
        - build
    script:
        - if [ -z ${REGISTRY_USER+x} ]; then echo "REGISTRY_USER não definida!"; exit 1; fi
        - if [ -z ${REGISTRY_PW+x} ]; then echo "REGISTRY_PW não definida!"; exit 1; fi
        # login no registro docker (Harbor)
        - docker login -u $REGISTRY_USER -p $REGISTRY_PW $REGISTRY
        # levantando o container de testes
        - make docker_up_test
        # realizando testes de disponibilidade do container de testes
        - make docker_log_test
    allow_failure: false
    tags:
        - node-busy
    only:
        - docker/nodejsbusybox

publish:
    stage: Prod-publish
    dependencies:
        - build
        - docker-tag
    script:
        # carrengando as variáveis "$REGISTRY_USER" e "$REGISTRY_PW" 
        - if [ -z ${REGISTRY_USER+x} ]; then echo "REGISTRY_USER não definida!"; exit 1; fi
        - if [ -z ${REGISTRY_PW+x} ]; then echo "REGISTRY_PW não definida!"; exit 1; fi
        # login no registro docker (Harbor)
        - docker login -u $REGISTRY_USER -p $REGISTRY_PW $REGISTRY
        # verificando as imagens antigas (Host)
        #- docker load -i image.tar
        # Enviando a nova imagem ao repositório (Harbor)
        - docker tag $REGISTRY/$REPOSITORY:latest $REGISTRY/$REPOSITORY:$VERSION
        - docker push $REGISTRY/$REPOSITORY:$VERSION
    tags:
        - node-busy
    only:
        - docker/nodejsbusybox

docker-tag:
    image: python:3.7-stretch
    stage: Prod-Tag
    dependencies:
        - build
    script:
        - mkdir -p ~/.ssh && chmod 700 ~/.ssh
        # utilizando a chave ssh para realizar o tagueamento da nova imagem
        - ssh-keyscan gitlab.com >> ~/.ssh/known_hosts && chmod 644 ~/.ssh/known_hosts
        - eval $(ssh-agent -s)
        #- echo -n "$SSH_DEPLOY_KEY" | tr -d '\r' | ssh-add - > /dev/null
        - chmod +x tag.py
        - ./tag.py
    #when: manual
    allow_failure: false
    tags:
        - node-busy
    only:
        - docker/nodejsbusybox

helm-tag:
    stage: Prod-Tag
    dependencies:
        - docker-tag
    before_script:
        - cd helm-chart/
    script:
        - make helm_tag
    #when: manual
    allow_failure: false
    tags:
        - node-busy
    only:
        - docker/nodejsbusybox
    needs: ["docker-tag"]

deploy-docker:
    stage: Deployment
    #before_script:
    #    - cd /home/gitlab-runner/projetos/nodejs-busybox
    script:
        - make deploy_docker
    #when: manual
    allow_failure: false
    tags:
        - node-busy
    only:
        - docker/nodejsbusybox
    environment:
      name: docker_staging
      url: http://10.10.36.21:3015/

#deploy-kubernetes:
    #stage: Deployment
    #before_script:
    #    - cd /home/gitlab-runner/projetos/nodejs-busybox
    #script:
        #- make deploy_kubernetes
    #when: manual
    #allow_failure: false
    #tags:
        #- node-busy
    #only:
        #- docker/nodejsbusybox
    #environment:
      #name: kubernetes_staging
      #url: http://10.10.34.21:3015/


change-image-tag-helm: &change-image-tag-helm
  image: 
    name: robertsilvatech/ubuntu-with-git:20.04
    entrypoint: [ '/bin/bash', '-c', 'ln -snf /bin/bash /bin/sh && /bin/bash -c $0' ] 
    
  stage: change-image-tag
  tags:
      - node-busy
  only:
      - docker/nodejsbusybox
  variables:
    CONFIG_REPO_NAME: busybox-nodejs
    PROJECT_FOLDER: nodejs-busybox
  before_script:
    - git config --global user.email "devops@unimednatal.com.br" && git config --global user.name "devopsunimed"    
  script:
    - echo "cloning config repo $CONFIG_REPO_NAME"
    - git clone "https://$CI_USER:$CI_USER_TOKEN@gitlab.com/unimed_natal/devops/helmcharts/busybox-nodejs"
    - echo "Entrando no diretório $CONFIG_REPO_NAME"
    - cd $CONFIG_REPO_NAME
    - echo "Listando arquivos"
    - ls -lh
    - git remote -v
    - git checkout -b $CI_PROJECT_NAME-$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA
    - 'ls $PROJECT_FOLDER/values.yaml | xargs sed -i -r "s/tag: (.*)/tag: $CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA/g"'
    - git status
    - git add .
    - git commit -m "Atualizando imagem através do repositório $CI_PROJECT_NAME - $CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA"
    - git push origin $CI_PROJECT_NAME-$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA
  only:
    - docker/nodejsbusybox