## NodeJS Unimed - Busybox - rodando no ambiente de desenvolvimento
# Este projeto é voltado para testes unistário em estágios do CI;

image: docker:latest
services:
    - docker:dind
stages:
    - Dev
    - Dev-test
    - Prod-Tag
    - Prod-publish
    - Deployment

variables:
    REGISTRY: harbor.unimednatal.com.br
    REPOSITORY: busybox-nodejs/unimed/nodejs-busybox 

before_script:
    # verificando a VERSÃO do arquivo
    - chmod +x script.sh; ./script.sh
    - if [ ! -f VERSION ]; then echo "A versão dessa imagem não foi encotrada!"; exit 1; else export VERSION=$(cat VERSION); fi
    - 'echo "Executando Pipeline para a imagem: $REGISTRY/$REPOSITORY:${VERSION}"'

build:
    stage: Dev
    script:
        - docker build -t $REGISTRY/$REPOSITORY .
        - docker save $REGISTRY/$REPOSITORY > image.tar
        #- docker image ls
    artifacts:
        paths:
            - image.tar
        expire_in: 1 day
    tags:
        - node-busy
    only:
        - docker/nodejsbusybox

dev-test:
    stage: Dev-test
    before_script:
        - cd /home/gitlab-runner/projetos/nodejs-busybox
    dependencies: 
        - build
    script:
        - if [ -z ${REGISTRY_USER+x} ]; then echo "REGISTRY_USER não definida!"; exit 1; fi
        - if [ -z ${REGISTRY_PW+x} ]; then echo "REGISTRY_PW não definida!"; exit 1; fi
        # login no registro docker (Harbor)
        - docker login -u $REGISTRY_USER -p $REGISTRY_PW $REGISTRY
        # pré-carregando versões de imagens antigas (backup)
        - docker load -i image.tar
        # levantando o container de testes
        - make docker_up_test
        # realizando testes de disponibilidade do container de testes
        - make docker_log_test
    allow_failure: false
    tags:
        - node-busy
    only:
        - docker/nodejsbusybox

publish:
    stage: Prod-publish
    dependencies:
        - build
        - tag
    script:
        # carrengando as variáveis "$REGISTRY_USER" e "$REGISTRY_PW" 
        - if [ -z ${REGISTRY_USER+x} ]; then echo "REGISTRY_USER não definida!"; exit 1; fi
        - if [ -z ${REGISTRY_PW+x} ]; then echo "REGISTRY_PW não definida!"; exit 1; fi
        # login no registro docker (Harbor)
        - docker login -u $REGISTRY_USER -p $REGISTRY_PW $REGISTRY
        # verificando as imagens antigas (Host)
        - docker load -i image.tar
        # Enviando a nova imagem ao repositório (Harbor)
        - docker tag $REGISTRY/$REPOSITORY:latest $REGISTRY/$REPOSITORY:$VERSION
        - docker push $REGISTRY/$REPOSITORY:$VERSION
    tags:
        - node-busy
    only:
        - docker/nodejsbusybox

tag:
    image: python:3.7-stretch
    stage: Prod-Tag
    script:
        - mkdir -p ~/.ssh && chmod 700 ~/.ssh
        # utilizando a chave ssh para realizar o tagueamento da nova imagem
        - ssh-keyscan gitlab.com >> ~/.ssh/known_hosts && chmod 644 ~/.ssh/known_hosts
        - eval $(ssh-agent -s)
        #- echo -n "$SSH_DEPLOY_KEY" | tr -d '\r' | ssh-add - > /dev/null
        - chmod +x tag.py
        - ./tag.py
    #when: manual
    allow_failure: false
    tags:
        - node-busy
    only:
        - docker/nodejsbusybox

deploy_docker:
    stage: Deployment
    before_script:
        - cd /home/gitlab-runner/projetos/nodejs-busybox
    script:
        - docker compose down
        - docker compose up -d
    #when: manual
    allow_failure: false
    tags:
        - node-busy
    only:
        - docker/nodejsbusybox
    environment:
      name: staging
      url: http://10.10.36.21:3015/